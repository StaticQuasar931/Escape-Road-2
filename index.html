<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="robots" content="noindex, nofollow">
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500&display=swap" rel="stylesheet">
  <title>Escape Road 2</title>
  <meta name="description" content="Escape Road 2 playable build for browsers on StaticQuasar931 GitHub Pages">

  <!-- Theme/CSS (kept relative so it works both on GitHub Pages and anywhere you copy this folder) -->
  <link rel="stylesheet" href="25050801/theme/game.css">

  <style>
    .jss1:before{
      top:0;
      width:100%;
      filter:blur(16px);
      height:100%;
      content:"";
      display:block;
      opacity:.5;
      z-index:0;
      position:absolute;
      background-size:cover;
      background-image:url("25050801/loading.png");
    }
    .error-banner{
      display:none;
      position:fixed;
      left:0;
      right:0;
      bottom:0;
      padding:12px 16px;
      background:#2b2b2b;
      color:#fff;
      font:14px/1.4 Arial,Helvetica,sans-serif;
      z-index:9999;
    }
    .error-banner.show{display:block}
    .error-banner code{background:#000; padding:2px 4px; border-radius:4px}
  </style>

  <script>
    // ---------- Helper: base path detection for GitHub Pages repo ----------
    // Works whether the page is served from /escape-road-2/ or elsewhere
    function detectRepoBase(repoName) {
      const parts = window.location.pathname.split("/").filter(Boolean);
      const idx = parts.indexOf(repoName);
      if (idx >= 0) return "/" + parts.slice(0, idx + 1).join("/");
      // fallback for custom hosting
      return "";
    }
    const REPO = "escape-road-2";
    const BASE = detectRepoBase(REPO); // e.g. "/escape-road-2" on GitHub Pages, "" elsewhere

    // ---------- Build/version settings ----------
    const VERSION = "25050801";
    const VERSION_DIR = VERSION + "/";
    const BUILD_DIR = VERSION_DIR + "Build";

    // Primary expected filenames from your Unity build
    const NAME_WITH_VERSION = "escape-road-2-v" + VERSION;
    const NAME_NO_VERSION  = "escape-road-2";

    // Candidate filename sets (loader + data + framework + wasm)
    // We will probe these in order and use the first set that exists.
    const CANDIDATES = [
      {
        // Your current naming
        loader:      `${BUILD_DIR}/${NAME_WITH_VERSION}.loader.js`,
        data:        `${BUILD_DIR}/${NAME_WITH_VERSION}.data.unityweb`,
        framework:   `${BUILD_DIR}/${NAME_WITH_VERSION}.framework.js.unityweb`,
        code:        `${BUILD_DIR}/${NAME_WITH_VERSION}.wasm.unityweb`
      },
      {
        // Fallback to names without version
        loader:      `${BUILD_DIR}/${NAME_NO_VERSION}.loader.js`,
        data:        `${BUILD_DIR}/${NAME_NO_VERSION}.data.unityweb`,
        framework:   `${BUILD_DIR}/${NAME_NO_VERSION}.framework.js.unityweb`,
        code:        `${BUILD_DIR}/${NAME_NO_VERSION}.wasm.unityweb`
      },
      {
        // Some exporters use underscores
        loader:      `${BUILD_DIR}/escape_road_2.loader.js`,
        data:        `${BUILD_DIR}/escape_road_2.data.unityweb`,
        framework:   `${BUILD_DIR}/escape_road_2.framework.js.unityweb`,
        code:        `${BUILD_DIR}/escape_road_2.wasm.unityweb`
      }
    ];

    // Check if a URL exists on the same origin
    async function urlExists(url) {
      try {
        const res = await fetch(url, { method: "HEAD", cache: "no-store" });
        return res.ok;
      } catch {
        return false;
      }
    }

    // Resolve first working candidate set, prefixed with BASE
    async function resolveBuildFiles() {
      for (const set of CANDIDATES) {
        const full = {
          loader:    BASE + "/" + set.loader,
          data:      BASE + "/" + set.data,
          framework: BASE + "/" + set.framework,
          code:      BASE + "/" + set.code
        };
        if (await urlExists(full.loader)) return full;
      }
      return null;
    }

    // Optional vendor SDK path, only load if present
    const GM_SDK_PATH = BASE + "/lib/gmsoftsdk_v5.js";

    async function maybeLoadGMSDK() {
      if (await urlExists(GM_SDK_PATH)) {
        const s = document.createElement("script");
        s.id = "gmsoft-jssdk";
        s.src = GM_SDK_PATH;
        document.head.appendChild(s);
      } // else skip silently to avoid 404 noise
    }

    // Host detection for Google Sites
    function isHostOnGoogleSites() {
      const h = location.hostname;
      return h.endsWith(".google.com") || h.endsWith(".googleusercontent.com") || h === "sites.google.com";
    }

    // Global config provided to Unity
    window.__ER2_CONFIG__ = {
      version: VERSION,
      companyName: "azgames.io",
      productName: "Escape Road 2",
      productVersion: VERSION,
      pubId: "",
      gameId: "escape-road-2",
      eventLog: false, // default off
      buildAPI: BASE + "/lib/event",
      enableMoreGame: "yes",
      enablePromotion: true,
      gdHost: isHostOnGoogleSites(),
      sdkType: null,
      gdGameId: null,
      streamingAssetsUrl: VERSION_DIR + "StreamingAssets"
    };

    // If hosted on Google Sites, disable promotions and logging
    if (window.__ER2_CONFIG__.gdHost) {
      window.__ER2_CONFIG__.enableMoreGame = "no";
      window.__ER2_CONFIG__.enablePromotion = false;
      window.__ER2_CONFIG__.eventLog = false;
      window.__ER2_CONFIG__.sdkType = "gd";
      window.__ER2_CONFIG__.gdGameId = "USE_GD_GAME_ID_CODE";
    }

    // No Cloudflare beacon here because its SRI/crossorigin was failing and causing console noise
    // If you want analytics, use Firebase below which is already included
  </script>
</head>

<body>
  <div id="unity-container" style="display:none;">
    <canvas id="unity-canvas"></canvas>
  </div>

  <div id="loadingBlock">
    <div class="jss31 jss34 jss1">
      <div style="position:absolute;font-family:Arial,Helvetica,sans-serif;bottom:10px;right:10px;font-size:18px;color:#ffffff;opacity:.5;">25050801</div>
      <div class="spinner"></div>
      <div class="jss31 jss34 jss48" style="flex:1 1 0%;">
        <div class="jss32">
          <div class="jss7 jss9 jss20 jss3">
            <div class="jss125">
              <div class="jss123">
                <img src="25050801/logo.png" alt="Escape Road 2 logo">
              </div>
            </div>
          </div>
        </div>
      </div>
      <!--PRODUCT_VERSION:25050801END-->
      <div class="jss31 jss34" style="flex:3 1 0%;">
        <div class="jss32">
          <div class="jss31 jss34 jss39 jss50 gameloader">
            <div class="jss32">
              <div class="gameloader-game-name">Escape Road 2</div>
            </div>
            <div class="jss32">
              <div class="jss32 gameloader-logo">
                <img id="game-logo" src="25050801/loading.png" alt="Loading">
              </div>
            </div>
            <div class="jss32">
              <div>
                <div class="gameloader-progressbar">
                  <div class="gameloader-progressbar-progress" id="progress_fill" style="width:0%;"></div>
                </div>
                <div class="gameloader-progress-info">Game Loading...</div>
                <img src="https://thegportal.net/GHub Logo 4.svg" style="height:100px;position:absolute;bottom:20px;left:20px;" alt="">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Error banner instead of alert popups -->
  <div id="errorBanner" class="error-banner"></div>

  <script>
    // Leave warning, per your global preference
    window.onbeforeunload = function(e){
      // Save any local state if needed here
      e.preventDefault();
      e.returnValue = "";
      return "";
    };

    const progressElement = document.getElementById("progress_fill");
    const container = document.getElementById("unity-container");
    const canvas = document.getElementById("unity-canvas");
    const loadingBar = document.querySelector("#loadingBlock");
    const progressText = document.querySelector(".gameloader-progress-info");
    const errorBanner = document.getElementById("errorBanner");

    function showError(msg) {
      errorBanner.innerHTML = `Load problem: <code>${msg}</code>`;
      errorBanner.classList.add("show");
      console.error(msg);
    }

    // Try to load vendor SDK only if it actually exists
    maybeLoadGMSDK();

    // Resolve build files, then load the Unity loader dynamically
    (async function boot() {
      const files = await resolveBuildFiles();
      if (!files) {
        showError("Could not locate Unity build files in " + (BASE || "/") + " " + BUILD_DIR);
        return;
      }

      // Prepare Unity config object
      const cfg = window.__ER2_CONFIG__;
      const unityConfig = {
        dataUrl: files.data,
        frameworkUrl: files.framework,
        codeUrl: files.code,
        streamingAssetsUrl: cfg.streamingAssetsUrl,
        companyName: cfg.companyName,
        productName: cfg.productName,
        productVersion: cfg.productVersion
      };

      // Load the loader
      const s = document.createElement("script");
      s.src = files.loader;
      s.onload = () => {
        if (typeof createUnityInstance !== "function") {
          showError("Unity loader loaded but createUnityInstance is not available");
          return;
        }
        createUnityInstance(canvas, unityConfig, (progress) => {
          const pct = Math.round(progress * 100);
          progressElement.style.width = pct + "%";
          progressText.textContent = pct < 99 ? ("Downloading file: " + pct + "%") : "Game Loading ...";
        }).then((unityInstance) => {
          window.unityInstance = unityInstance;
          setTimeout(() => {
            loadingBar.style.display = "none";
            window.focus();
          }, 1200);
          container.style.display = "block";
        }).catch((message) => {
          showError(message);
        });
      };
      s.onerror = () => showError("Failed to load Unity loader: " + files.loader);
      document.body.appendChild(s);
    })();
  </script>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-analytics-compat.js"></script>
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDDb7OnEwOH2yFyzxqMGaxnMb7D6z0zAoE",
      authDomain: "escape-road-2.firebaseapp.com",
      projectId: "escape-road-2",
      storageBucket: "escape-road-2.firebasestorage.app",
      messagingSenderId: "106330943494",
      appId: "1:106330943494:web:1a4c40bdd625509f761387",
      measurementId: "G-WCKVNNMBMJ"
    };
    if (firebaseConfig) {
      window.dataLayer = window.dataLayer || [];
      window.gtag = function(){ window.dataLayer.push(arguments); };
      window.gtag("config", firebaseConfig.measurementId, {
        cookie_domain: window.location.hostname,
        cookie_flags: "SameSite=None;Secure"
      });
      firebase.initializeApp(firebaseConfig);
      // Initialize analytics if available
      try { firebase.analytics(); } catch(e) {}
    }

    // Convenience wrappers you already had
    function firebaseSetUserProperties(props) {
      try { firebase.analytics().setUserProperties(props); } catch(e) {}
    }
    function firebaseLogEvent(event_name) {
      try { firebase.analytics().logEvent(event_name); } catch(e) {}
    }
    function firebaseLogEventParameter(event_name, event_param) {
      try { firebase.analytics().logEvent(event_name, event_param); } catch(e) {}
    }
  </script>
</body>
</html>
